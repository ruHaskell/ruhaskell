<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content>
        <meta name="author" content>
        <link rel="icon" href="../../../../../static/images/favicon.ico">

        <title>Знакомство с Threepenny-GUI</title>

        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">

        <link href="../../../../../static/css/default.css" rel="stylesheet">
        
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

        <script>
          window.___gcfg = {
            lang: 'ru'
          };
        </script>

        <script src="https://apis.google.com/js/platform.js" async defer>
        </script>
    
        <link rel="alternate" type="application/rss+xml" title="RSS" href="http://ruhaskell.org/feed.xml" />
        
        <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>
    </head>

  <body>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-58217738-1', 'auto');
      ga('send', 'pageview');

    </script>

    <div class="container">
        <nav class="navbar navbar-default navbar-fixed-top">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <div id="ruhaskell-logo">
                <a class="navbar-brand" href="../../../../../" title="Домой">
                  <img alt="ruHaskell" src="../../../../../static/images/logo.png" width="60">
                </a>
              </div>
            </div>
            
            <div id="navbar" class="collapse navbar-collapse">
              <ul class="nav navbar-nav">
                <li class="dropdown">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Публикации<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li>
                        <a href="../../../../../archive.html">
                            <span class="archive-link">
                                <span class="fa fa-pencil"></span>
                            </span>Статьи
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../tags.html">
                            <span class="tags-link">
                                <span class="fa fa-tags"></span>
                            </span>Теги
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../categories.html">
                            <span class="categories-link">
                                <span class="fa fa-star"></span>
                            </span>Категории
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../authors.html">
                            <span class="authors-link">
                                <span class="fa fa-users"></span>
                            </span>Авторы
                        </a>
                    </li>
                  </ul>
                </li>

                <li class="dropdown">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Общение<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li>
                        <a href="https://gitter.im/ruHaskell/forall" target="_blank">
                            <span class="chat-link">
                                <span class="fa fa-smile-o"></span>
                            </span>Чат
                        </a>
                    </li>
                    <li>
                        <a href="http://forum.ruhaskell.org" target="_blank">
                            <span class="group-link">
                                <span class="fa fa-group"></span>
                            </span>Форум
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../maillist.html">
                            <span class="group-link">
                                <span class="fa fa-group"></span>
                            </span>Список рассылки
                        </a>
                    </li>
                  </ul>
                </li>

                <li><a href="../../../../../links.html">Ссылки</a></li>
              </ul>

              <ul class="nav navbar-nav navbar-right">
                <li class="dropdown">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Присоединяйтесь!<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li>
                        <a href="https://github.com/ruHaskell/ruhaskell" target="_blank">
                            <span id="github-link">
                                <span class="fa fa-github-square"></span>
                            </span>GitHub
                        </a>
                    </li>
                    <li>
                        <a href="https://plus.google.com/communities/117343381540538069054" target="_blank">
                            <span id="google-plus-link">
                                <span class="fa fa-google-plus-square"></span>
                            </span>Google+
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../feed.xml">
                            <span id="rss-link">
                                <span class="fa fa-rss-square"></span>
                            </span>RSS
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../itunes-feed.xml">
                            <span id="itunes-rss-link">
                                <span class="fa fa-rss-square"></span>
                            </span>iTunes
                        </a>
                    </li>
                  </ul>
                </li>
              </ul>
            </div>
          </div>
        </nav>

        <div id="content">
            <h1>Знакомство с Threepenny-GUI</h1>

<div class="row">
    <div class="col-xs-9 col-sm-8 col-md-8 col-lg-8">
        <div class="post-info">
            <strong>let</strong> author&nbsp;&nbsp;&nbsp;= "<a href="../../../../../authors/%25D0%2590%25D0%25BB%25D0%25B5%25D0%25BA%25D1%2581%25D0%25B5%25D0%25B9%2520%25D0%259F%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B3%25D0%25BE%25D0%25B2.html">Алексей Пирогов</a>"<br />
            &nbsp;&nbsp;&nbsp;&nbsp;date&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= fromGregorian 2015 jan 22<br />
            &nbsp;&nbsp;&nbsp;&nbsp;category = "<a href="../../../../../categories/gui.html">GUI</a>"<br />
            &nbsp;&nbsp;&nbsp;&nbsp;tags&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= [&quot;<a href="../../../../../tags/GUI.html">GUI</a>&quot;, &quot;<a href="../../../../../tags/FRP.html">FRP</a>&quot;]
        </div>
    </div>

    <div class="col-xs-3 col-sm-4 col-md-4 col-lg-4">
        
    </div>
</div>

<h2 id="что-же-это">Что же это?</h2>
<p>Реализация графического интерфейса для приложений, это, к сожалению, пока ещё непростая задача (по крайней мере, для разработчиков на Haskell). Ещё больше усложняет задачу необходимость сделать приложение кроссплатформенным. Создатель <a href="https://www.haskell.org/haskellwiki/Threepenny-gui">Threepenny-GUI</a> предлагает одно из решений данной проблемы - использование в качестве средства отображения интерфейса браузер. Такое решение даёт очевидные преимущества: используя браузер, мы получаем отличную кросплатформенность и богатые возможности для оформления интерфейса. А кроме того Threepenny-GUI даёт нам возможность использовать при разработке ещё и FRP - Function Reactive Programming - очень мощный подход для разработки ПО, особенно - интерактивного. FRP в данном случае основывается на библиотеке <a href="https://www.haskell.org/haskellwiki/Reactive-banana">Reactive Banana</a>.</p>
<p>Замечу, что не стоит делать поспешных выводов и решать для себя, что разработка приложений, рассчитанных на отображение в браузере, подразумевает под собой создание странички на HTML+JS с прикручиванием оной к простенькому серверу. К счастью, в данном случае это не так!</p>
<p>Данная статья, надеюсь, даст представление о возможности быстрой разработки GUI на Haskell, достаточное для того, чтобы иметь данный подход ввиду, буде такая задача возникнет.</p>
<p>Примером нам будет служить приложение, имитирующее настольный калькулятор с базовым набором операций. Его мы и разработаем. Итак, поехали!</p>
<div class="figure">
<img src="https://www.haskell.org/wikiupload/7/7c/Reactive-Banana-banana.png" alt />

</div>
<h2 id="окно">Окно</h2>
<blockquote>
<p>А мы увидели Солнце, открыли окна. А иначе зачем это все? (© “Пикник”)</p>
</blockquote>
<p>Каждое (ну, почти каждое) графическое приложение начинается с <em>окна</em>. Threepenny создаёт окно сама (помним, что это страница в браузере), от нас же ожидается его настройка и наполнение. Поручим это функции <code>setup</code>, которая будет вызываться из <code>main</code>:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import           </span><span class="dt">Control.Monad</span>               (void)
<span class="kw">import qualified</span> <span class="dt">Graphics.UI.Threepenny</span>      <span class="kw">as</span> <span class="dt">UI</span>
<span class="kw">import           </span><span class="dt">Graphics.UI.Threepenny</span>      (set, title, (#), <span class="dt">UI</span>, <span class="dt">Window</span>)
<span class="kw">import           </span><span class="dt">Graphics.UI.Threepenny.Core</span> (startGUI, defaultConfig)

<span class="co">-- ...</span>

<span class="ot">setup ::</span> <span class="dt">Window</span> <span class="ot">-&gt;</span> <span class="dt">UI</span> ()
setup win <span class="fu">=</span> void <span class="fu">$</span> <span class="kw">do</span>
  return win <span class="fu">#</span> set title <span class="st">&quot;ReaCalc&quot;</span>

<span class="ot">main ::</span> <span class="dt">IO</span> ()
main <span class="fu">=</span> startGUI defaultConfig setup</code></pre></div>
<p>Из кода видно, что работа с окном происходит в специальной монаде <code>UI</code>: cамо окно (как и все остальные UI-элементы) - “чистое”, а операции над ним - “не очень”, поэтому типичное взаимодействие с элементом выглядит так: <code>return elem # set ... ...</code>.</p>
<p>В общем то, всё! Приложение уже можно запускать! У меня это выглядит так:</p>
<pre class="shell"><code>$ cabal run
Listening on http://127.0.0.1:8023/
[22/Jan/2015:20:23:04 +0300] Server.httpServe: START, binding to [http://127.0.0.1:8023/]</code></pre>
<p>Открыв в браузере url <code>http://127.0.0.1:8023/</code>, мы увидим страницу с указанным нами <em>title</em>. Да, страница пока пуста, но приложение уже работает!</p>
<p>Настало время наполнить окно содержимым. Создадим “индикатор” - элемент, отображающий результаты вычислений. Под индикатором будет располагаться блок клавиш. Дополним <code>setup</code>:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import           </span><span class="dt">Graphics.UI.Threepenny</span>      (set, attr, text, value, (#+))

<span class="co">-- ...</span>

setup win <span class="fu">=</span> <span class="co">-- ...</span>
  <span class="fu">---</span> <span class="fu">...</span>
  out <span class="ot">&lt;-</span> UI.input <span class="fu">#</span> set (attr <span class="st">&quot;readonly&quot;</span>) <span class="st">&quot;true&quot;</span>
                  <span class="fu">#</span> set (attr <span class="st">&quot;style&quot;</span>) <span class="st">&quot;text-align: right; min-width: 240px&quot;</span>
                  <span class="fu">#</span> set value <span class="st">&quot;0&quot;</span>

  buttons <span class="ot">&lt;-</span> mapM (mapM mkButton) buttonLabels

  UI.getBody win <span class="fu">#+</span> [return out]
                 <span class="fu">#+</span> map UI.row (map (map return) buttons)

  <span class="kw">where</span>
    mkButton s <span class="fu">=</span> UI.input <span class="fu">#</span> set text s
                          <span class="fu">#</span> set value s
                          <span class="fu">#</span> set (attr <span class="st">&quot;type&quot;</span>) <span class="st">&quot;button&quot;</span>
                          <span class="fu">#</span> set (attr <span class="st">&quot;style&quot;</span>) <span class="st">&quot;min-width: 50px&quot;</span>

<span class="ot">buttonLabels ::</span> [[<span class="dt">String</span>]]
buttonLabels <span class="fu">=</span> map words <span class="fu">$</span> lines <span class="st">&quot;7 8 9 CE C\n4 5 6 + -\n1 2 3 * /\n . 0 =&quot;</span></code></pre></div>
<p>Элементы управления настраиваются так же, как это делалось бы в HTML - мы добавляем стили, указываем атрибуты, и т.п. Но всё оперирование компонентами производится на Haskell, ну не красота ли!? (на самом деле, красоты в текущем интерфейсе мало - на вид он, что называется, “инженерный”. Ну да ладно, эта статья не о дизайне, всё таки!)</p>
<p>Теперь интерфейс в наличии, настало время его “оживить”!</p>
<h2 id="логика">Логика</h2>
<blockquote>
<p>I’m the operator with my pocket calculator<br /> I am adding, and subtracting<br /> I’m controlling, and composing (© Kraftwerk)</p>
</blockquote>
<p>Логика работы калькулятора реализована в модуле <code>Calc</code>. В статье потребуется лишь API, предоставляемый модулем:</p>
<ul>
<li><code>State</code> - внутреее состояние калькулятора. Начальное стостояние можно получить через <code>def :: State</code> (соответствующий класс типов реализован);</li>
<li><code>populate :: String -&gt; State -&gt; State</code> - модификатор состояния, изменяющий оное в соответствии со строковой командой;</li>
<li><code>display :: State -&gt; String</code> - функция, педоставляющая отображение состояния в привычном виде (текущее значение на “экране” “калькулятора”).</li>
</ul>
<p>Пройдя по ссылке на исходники в конце статьи, можно познакомиться с содержимым модуля.</p>
<h2 id="интерактив">Интерактив</h2>
<blockquote>
<p>By pressing down a special key,<br /> it plays a little melody (© Kraftwerk)</p>
</blockquote>
<p>В Reactive Banana интерактивность описывется в терминах <code>Event</code> и <code>Behaviour</code>.</p>
<p><code>Event a</code> представляет собой, не одиночное событие, как это бывает в классических event-driven системах, а поток событий, выдаваемых потоком по мере того, как оные происходят. Каждое событие в потоке сопровождается временной отметкой и содержит некие данные (типа <code>a</code>), характеризующие событие. Два потока событий одного типа можно объединить в один с помощью комбинатора</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">UI.unionWith<span class="ot"> ::</span> (a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> a) <span class="ot">-&gt;</span> <span class="dt">Event</span> a <span class="ot">-&gt;</span> <span class="dt">Event</span> a <span class="ot">-&gt;</span> <span class="dt">Event</span> a</code></pre></div>
<p>Этот комбинатор, помимо, собственно, объединения потоков, занимается обработкой ситуации, когда два события из разных потоков имеют одинаковую временную отметку: в этом случае вызывается функция, передаваемая в комбинатор первым параметром - она то и решает, что делать с данными.</p>
<p><code>Behaviour a</code>, в свою очередь, изображает некую “ячейку”, в которой <em>содержатся</em> данные типа <code>a</code>. Данные в коробке всегда имеют некое мгновенное значение, меняющееся с течением времени под действием событий.</p>
<p>Наша программа изображает некое устройство (калькулятор), имеющее начальное состояние, возникающее единожды при “включении”. В процессе работы это состояние меняется под действием команд (нажатий кнопок). Индикатор же калькулятора занимается отображением значения, характеризующего это сотояние. При этом, состояние существует в течении всего времени работы кальклятора.</p>
<p>Тут нам пригодится функция</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">UI.accumB<span class="ot"> ::</span> <span class="dt">MonadIO</span> m <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Event</span> (a <span class="ot">-&gt;</span> a) <span class="ot">-&gt;</span> m (<span class="dt">Behavior</span> a)</code></pre></div>
<p>Она принимает начальное значение и поток событий, содержащих функции, способные изменить это значение, а возвращает - “поведение”, т.е. ячейку в которой и будет храниться изменяющееся во времени состояние.</p>
<p>Дополним функцию <code>setup</code> кодом, отвечающим да интерактив:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import           </span><span class="dt">Graphics.UI.Threepenny</span>      ((&lt;@), <span class="dt">Event</span>, sink, accumB)
<span class="co">-- ...</span>
setup win <span class="fu">=</span> <span class="co">-- ...</span>
  <span class="co">-- ...</span>
  <span class="kw">let</span> clicks <span class="fu">=</span> buttonClicks (zip (concat buttons) (concat buttonLabels))
      commands <span class="fu">=</span> fmap populate clicks
  calcBehaviour <span class="ot">&lt;-</span> accumB (<span class="ot">def ::</span> <span class="dt">State</span>) commands
  return out <span class="fu">#</span> sink value (fmap display calcBehaviour)
  <span class="co">-- ...</span>
  <span class="kw">where</span>
<span class="ot">    buttonClicks ::</span> [(<span class="dt">Element</span>, <span class="dt">String</span>)] <span class="ot">-&gt;</span> <span class="dt">Event</span> <span class="dt">String</span>
    buttonClicks <span class="fu">=</span> foldr1 (UI.unionWith const) <span class="fu">.</span> map makeClick
      <span class="kw">where</span>
        makeClick (e, s) <span class="fu">=</span> (UI.pure s) <span class="fu">&lt;@</span> (UI.click e)</code></pre></div>
<p>Некоторого пояснения требует код функции <code>makeClick</code>, но на самом деле тут всё просто: клики по кнопке (<code>e</code>) попадают в поток, но значения событий отбрасываются (комбинатором <code>&lt;@</code>), а вместо них вставляется текст кнопки (<code>pure s</code>).</p>
<p>А <code>sink</code> в коде означает “сток” - связывание ячейки со свойством элемента (тут это <code>value</code>). После связывания изменяющееся значение будет автоматически отражаться на “индикаторе”.</p>
<p>К вышеперечисленному хочется добавить, что <code>Event</code> и <code>Behaviour</code> реализуют класс <code>Functor</code>. Это позволяет обрабатывать потоки событий очень “функционально”!</p>
<h2 id="заключение">Заключение</h2>
<p>Приложение реализовано! Кода получилось немного, но даже этот небольшой пример в достаточной мере демонстрирует, что с помощью FRP можно писать GUI в функциональном стиле, не скатываясь в “callback hell”. Даже внутреннее состояние реализуется явно, что должно радовать любого функциональщика (надеюсь).</p>
<p>Исходники проекта можно посмотреть <a href="https://bitbucket.org/astynax/threep">тут</a></p>

<div id="socialButtons">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ru">Твитнуть</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

    <div class="g-plus" data-action="share" data-annotation="bubble"></div>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'ruhaskell'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    

        </div> 

        <div id="searchForm">
            <script>
              (function() {
                var cx = '007697214108744450483:w49n7qbvpdy';
                var gcse = document.createElement('script');
                gcse.type = 'text/javascript';
                gcse.async = true;
                gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                    '//www.google.com/cse/cse.js?cx=' + cx;
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(gcse, s);
              })();
            </script>
            <gcse:search></gcse:search>
        </div>

        <footer class="footer">
            Сайт работает на <strong><a href="http://jaspervdj.be/hakyll/" target="_blank">Hakyll</a></strong> и живёт на <strong><a href="https://github.com/ruHaskell/ruhaskell" target="_blank">GitHub</a></strong>.
            <div class="stargaze">
                <a data-count-api="/repos/ruHaskell/ruhaskell#stargazers_count" data-count-href="/ruHaskell/ruhaskell/stargazers" data-icon="octicon-star" href="https://github.com/ruHaskell/ruhaskell" class="github-button">Star</a>

                <span style="padding-left: 20px;"></span>            
                
                <a data-count-api="/repos/ruHaskell/ruhaskell#forks_count" data-count-href="/ruHaskell/ruhaskell/network" data-icon="octicon-git-branch" href="https://github.com/ruHaskell/ruhaskell" class="github-button">Fork</a>
            </div>

            <div class="copyright-note">
                Исходный код данного сайта, а также все опубликованные на нём материалы распространяются на условиях <a href="https://github.com/ruHaskell/ruhaskell/blob/master/LICENSE" target="_blank">свободной лицензии MIT</a>.
            </div>
        </footer>
    </div>

<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'ruhaskell'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
var s = document.createElement('script'); s.async = true;
s.type = 'text/javascript';
s.src = '//' + disqus_shortname + '.disqus.com/count.js';
(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script> 

  </body>
</html>

