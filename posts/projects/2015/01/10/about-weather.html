<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content>
        <meta name="author" content>
        <link rel="icon" href="../../../../../static/images/favicon.ico">

        <title>О погоде функционально</title>

        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">

        <link href="../../../../../static/css/default.css" rel="stylesheet">

        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

        <script>
          window.___gcfg = {
            lang: 'ru'
          };
        </script>

        <script src="https://apis.google.com/js/platform.js" async defer>
        </script>

        <link rel="alternate" type="application/rss+xml" title="RSS" href="http://ruhaskell.org/feed.xml" />

        <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>
    </head>

  <body>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-58217738-1', 'auto');
      ga('send', 'pageview');

    </script>

    <div class="container">
        <nav class="navbar navbar-default navbar-fixed-top">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <div id="ruhaskell-logo">
                <a class="navbar-brand" href="../../../../../" title="Домой">
                  <img alt="ruHaskell" src="../../../../../static/images/logo.png" width="60">
                </a>
              </div>
            </div>

            <div id="navbar" class="collapse navbar-collapse">
              <ul class="nav navbar-nav">
                <li class="dropdown">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Публикации<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li>
                        <a href="../../../../../archive.html">
                            <span class="archive-link">
                                <span class="fa fa-pencil"></span>
                            </span>Статьи
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../tags.html">
                            <span class="tags-link">
                                <span class="fa fa-tags"></span>
                            </span>Теги
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../categories.html">
                            <span class="categories-link">
                                <span class="fa fa-star"></span>
                            </span>Категории
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../authors.html">
                            <span class="authors-link">
                                <span class="fa fa-users"></span>
                            </span>Авторы
                        </a>
                    </li>
                  </ul>
                </li>

                <li class="dropdown">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Общение<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li>
                        <a href="https://gitter.im/ruHaskell/forall" target="_blank">
                            <span class="chat-link">
                                <span class="fa fa-smile-o"></span>
                            </span>Чат
                        </a>
                    </li>
                    <li>
                        <a href="http://forum.ruhaskell.org" target="_blank">
                            <span class="group-link">
                                <span class="fa fa-group"></span>
                            </span>Форум
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../maillist.html">
                            <span class="group-link">
                                <span class="fa fa-group"></span>
                            </span>Список рассылки
                        </a>
                    </li>
                  </ul>
                </li>

                <li><a href="../../../../../links.html">Ссылки</a></li>
              </ul>

              <ul class="nav navbar-nav navbar-right">
                <li class="dropdown">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Присоединяйтесь!<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li>
                        <a href="https://github.com/ruHaskell/ruhaskell" target="_blank">
                            <span id="github-link">
                                <span class="fa fa-github-square"></span>
                            </span>GitHub
                        </a>
                    </li>
                    <li>
                        <a href="https://plus.google.com/communities/117343381540538069054" target="_blank">
                            <span id="google-plus-link">
                                <span class="fa fa-google-plus-square"></span>
                            </span>Google+
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../feed.xml">
                            <span id="rss-link">
                                <span class="fa fa-rss-square"></span>
                            </span>RSS
                        </a>
                    </li>
                    <li>
                        <a href="https://itunes.apple.com/ru/podcast/banany-i-linzy/id1037879859" target="_blank">
                            <span id="itunes-rss-link">
                                <span class="fa fa-rss-square"></span>
                            </span>iTunes
                        </a>
                    </li>
                  </ul>
                </li>
              </ul>
            </div>
          </div>
        </nav>

        <div id="content">
            <h1>О погоде функционально</h1>

<div class="row">
    <div class="col-xs-9 col-sm-8 col-md-8 col-lg-8">
        <div class="post-info">
            <strong>let</strong> author&nbsp;&nbsp;&nbsp;= "<a href="../../../../../authors/%25D0%2590%25D0%25BB%25D0%25B5%25D0%25BA%25D1%2581%25D0%25B5%25D0%25B9%2520%25D0%259F%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B3%25D0%25BE%25D0%25B2.html">Алексей Пирогов</a>"<br />
            &nbsp;&nbsp;&nbsp;&nbsp;date&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= fromGregorian 2015 jan 10<br />
            &nbsp;&nbsp;&nbsp;&nbsp;category = "<a href="../../../../../categories/projects.html">Проекты</a>"<br />
            &nbsp;&nbsp;&nbsp;&nbsp;tags&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= [&quot;<a href="../../../../../tags/%25D0%25BF%25D0%25BE%25D0%25B3%25D0%25BE%25D0%25B4%25D0%25B0.html">погода</a>&quot;, &quot;<a href="../../../../../tags/CLI.html">CLI</a>&quot;]
        </div>
    </div>

    <div class="col-xs-3 col-sm-4 col-md-4 col-lg-4">
        
            <div class="href-to-original">
                <a href="https://astynax.github.io/posts/2014-11-22-o-pogode-funktsionalno.html" target="_blank">Оригинал <span class="fa fa-external-link"></span></a>
            </div>
        
    </div>
</div>

<p>Недавно, очередной раз взглянув за окно, вдруг подумал: <em>“Интересно, а сколько там градусов за окном?”</em>. Сегодня, имея браузер под рукой, ответить на этот вопрос несложно, и даже точность прогноза будет вполне приличной. Однако даже этот способ имеет недостаток - <strong>слишком много телодвижений</strong>! И конечно же вожжа попала под нужное место: я решил написать простенькую программку, запрашивающую погоду. Ну и, как водится, на <a href="https://www.haskell.org/haskellwiki/Haskell"><strong>Haskell</strong></a></p>
<p>Выводить погоду я решил в статусную строку моего оконного менеджера (<a href="http://i3wm.org/">i3wm</a>), а информация, выводимая на оной, должна быть исключительно текстовой. Для краткого прогноза в стиле <code>-5, облачно</code> вполне подходит. Напросились следующие требования к программе:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Command-line_interface">CLI</a>-интерфейс</li>
<li>вывод погоды как для заданного города (на момент написания, это была Казань), так и для любого другого - указанием через опции командной строки</li>
<li>получение данных о погоде от <a href="https://developer.yahoo.com/weather/">Yahoo weather</a> (выбор пал на этот сервис, т.к. этот API был уже знаком)</li>
<li>возможность добавлять в дальнейшем дополнительные сервисы, предоставляющие данные о погоде</li>
</ul>
<p>Надо сказать, ещё одной целью написания этой программы, помимо, собственно, полезности конечного результата, стала возможность написать что-то практичное на Haskell. А заодно и изучить, как на Haskell</p>
<ul>
<li><strong>запрашивать</strong> что-то <strong>через HTTP</strong></li>
<li><strong>парсить XML</strong></li>
<li><strong>реализовывать CLI-опции</strong></li>
</ul>
<p>В таком порядке я реализовал функции приложения, буду придерживаться этого порядка и здесь. Но с начала</p>
<h2 id="типа-типы">“Типа, типы”</h2>
<p>Haskell учит: <strong>Сначала типы, постом всё остальное!</strong></p>
<p>Посему:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import </span><span class="dt">Data.Text</span>

<span class="co">-- Единицы измерения температуры</span>
<span class="kw">data</span> <span class="dt">TempUnits</span> <span class="fu">=</span> <span class="dt">Celsiuses</span>
               <span class="fu">|</span> <span class="dt">Farenheits</span>

<span class="kw">data</span> <span class="dt">Weather</span> <span class="fu">=</span> <span class="dt">Weather</span>
             {<span class="ot"> getCity    ::</span> <span class="dt">Text</span>
             ,<span class="ot"> getCountry ::</span> <span class="dt">Text</span>
             ,<span class="ot"> getTemp    ::</span> <span class="dt">Text</span>
             ,<span class="ot"> getUnits   ::</span> <span class="dt">TempUnits</span>
             ,<span class="ot"> getDate    ::</span> <span class="dt">Text</span>
             ,<span class="ot"> getText    ::</span> <span class="dt">Text</span> }

<span class="co">-- пара алиасов для красоты</span>
<span class="kw">type</span> <span class="dt">CityID</span> <span class="fu">=</span> <span class="dt">String</span>
<span class="kw">type</span> <span class="dt">Url</span> <span class="fu">=</span> <span class="dt">String</span></code></pre></div>
<p>Данные о погоде хранятся преимущественно в полях типа <code>Text</code>, т.к. могут содержат символы Unicode, да и получаться будут из XML, текст в котором хранится именно в <code>Text</code>.</p>
<p>Т.к. погоду предстояло выводить в текстовом виде, реализовал приведение <code>Weather</code> к строке. Вот как это выглядит:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">renderWeather ::</span> <span class="dt">Weather</span> <span class="ot">-&gt;</span> <span class="dt">String</span>
renderWeather w <span class="fu">=</span>
  concat [ unpack (getDate w), <span class="st">&quot;: &quot;</span>
         , unpack (getCity w)
         , <span class="st">&quot;(&quot;</span>, unpack (getCountry w), <span class="st">&quot;), &quot;</span>
         , unpack (getTemp w)
         , <span class="kw">case</span> getUnits w <span class="kw">of</span>
              <span class="dt">Celsiuses</span>  <span class="ot">-&gt;</span> <span class="st">&quot;°C&quot;</span>
              <span class="dt">Farenheits</span> <span class="ot">-&gt;</span> <span class="st">&quot;°F&quot;</span>
         , <span class="st">&quot;, &quot;</span>
         , unpack (getText w)]</code></pre></div>
<p>Вывод же получается следующим</p>
<p><code>Fri, 21 Nov 2014 9:59 pm MSK: Kazan'(Russia), -5°C, Fog</code></p>
<blockquote>
<p>Правда, в конце концов я решил, что выглядит такая “портянка” громоздко и, путем комментирования первых трёх строк, сократил выводимый текст до <code>-5°C, Fog</code></p>
</blockquote>
<p>Ну вот, данные есть, теперь можно вернуться к первоначальному плану. Итак</p>
<h2 id="ну-и-запросы-у-вас">“Ну и запросы у вас!”</h2>
<p>Работа с протоколом HTTP в Haskell обычно делается силами пакета… HTTP! Кхм, даже скучно как-то. Первый вариант функции отправки запроса с возвратом тела ответа выглядел так:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- Импорты</span>
<span class="kw">import </span><span class="dt">Network.HTTP</span> ( catchIO
                    , getRequest, getResponseBody
                    , simpleHTTP )

<span class="fu">...</span>

<span class="co">-- собственно, функция отправки запросов</span>
<span class="ot">request ::</span> <span class="dt">Url</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">String</span>)
request url <span class="fu">=</span>
  catchIO (liftM <span class="dt">Just</span> (simpleHTTP (getRequest url)
                   <span class="fu">&gt;&gt;=</span> getResponseBody))
          (const (return <span class="dt">Nothing</span>))</code></pre></div>
<p>Здесь всё довольно просто: результатом неудавшегося запросы будет просто <code>Nothing</code>, а в случае удачи вернётся <code>Just &quot;...&quot;</code> с телом ответа.</p>
<p>Url же формировать было поручено этой функции:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">mkAPIUrl ::</span> <span class="dt">CityID</span> <span class="ot">-&gt;</span> <span class="dt">TempUnits</span> <span class="ot">-&gt;</span> <span class="dt">Url</span>
mkAPIUrl city units <span class="fu">=</span>
  <span class="kw">let</span> unitStr <span class="fu">=</span> <span class="kw">case</span> units <span class="kw">of</span>
                  <span class="dt">Celsiuses</span>  <span class="ot">-&gt;</span> <span class="st">&quot;c&quot;</span>
                  <span class="dt">Farenheits</span> <span class="ot">-&gt;</span> <span class="st">&quot;f&quot;</span>
  <span class="kw">in</span> <span class="st">&quot;http://weather.yahooapis.com/forecastrss?w=&quot;</span>
  <span class="fu">++</span> city <span class="fu">++</span> <span class="st">&quot;&amp;u=&quot;</span> <span class="fu">++</span> unitStr</code></pre></div>
<p>Здесь тоже всё прозрачно, я считаю.</p>
<p>Этот вариант HTTP-клиента работал у меня отлично дома, однако через офисный <strong>proxy-сервер</strong> пробиться сходу он, увы, не смог. Ну да ладно, на то он и <code>simpleHTTP</code> - ему простительно. Гугление подсказало, что через прокси может ходить <code>Network.HTTP.Browser</code>. Решено было его и использовать. Теперь код запроса погоды выглядит так:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- Новые импорты</span>
<span class="kw">import </span><span class="dt">Network.Browser</span>    (browse, request,
                           setOutHandler, setProxy)
<span class="kw">import </span><span class="dt">Network.HTTP</span>       (<span class="dt">Response</span> (rspBody),
                           catchIO, getRequest)
<span class="kw">import </span><span class="dt">Network.HTTP.Proxy</span> (<span class="dt">Proxy</span>, fetchProxy, parseProxy)

<span class="fu">...</span>

<span class="ot">simpleRequest ::</span> <span class="dt">Maybe</span> <span class="dt">Proxy</span>
              <span class="ot">-&gt;</span> <span class="dt">Url</span>
              <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> <span class="dt">String</span>)
simpleRequest mbProxy url <span class="fu">=</span>
  catchIO (liftM <span class="dt">Just</span> get)
          (const (return <span class="dt">Nothing</span>))
  <span class="kw">where</span>
<span class="ot">    get ::</span> <span class="dt">IO</span> <span class="dt">String</span>
    get <span class="fu">=</span> <span class="kw">do</span>
      <span class="co">-- если proxy не указан явно, программа будет</span>
      <span class="co">-- пытаться получить его настройки от ОС</span>
      p <span class="ot">&lt;-</span> maybe (fetchProxy <span class="dt">False</span>) return mbProxy
      (_, res) <span class="ot">&lt;-</span> browse <span class="fu">$</span> <span class="kw">do</span>
        setProxy p
        <span class="co">-- весь вывод в консоль от браузера подавляется</span>
        setOutHandler <span class="fu">$</span> const <span class="fu">$</span> return ()
        request (getRequest url)
      return (rspBody res)</code></pre></div>
<h2 id="что-то-неразборчив-ваш-xml-без-линз-никак">“Что-то неразборчив ваш XML, без линз никак!”</h2>
<p>XML-документы в Haskell хранятся в типе <code>Document</code> из модуля <code>Text.XML</code>. Получить же документ из строки с содержимым можно так:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import qualified</span> <span class="dt">Data.Text</span>    <span class="kw">as</span> <span class="dt">T</span>
<span class="kw">import           </span><span class="dt">Data.Default</span> (def)
<span class="kw">import qualified</span> <span class="dt">Text.XML</span>     <span class="kw">as</span> <span class="dt">X</span>
<span class="kw">import           </span><span class="dt">Text.XML</span>     (<span class="dt">Document</span>)

<span class="fu">...</span>

<span class="ot">parseDocument ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Document</span>
parseDocument s <span class="fu">=</span>
  <span class="kw">case</span> X.parseText def (T.pack s) <span class="kw">of</span>
    <span class="dt">Right</span> d <span class="ot">-&gt;</span> <span class="dt">Just</span> d
    _       <span class="ot">-&gt;</span> <span class="dt">Nothing</span></code></pre></div>
<p><code>parseText</code> возвращает <code>Either</code>, содержащий описание ошибок парсинга. Однако, данная задача не требует таких подробностей, поэтому функция, приведенная выше, возвращает просто <code>Maybe Document</code>.</p>
<p>Документ получать уже можно, но ведь нужно ещё и работать с ним. Будучи знаком с линзами, я прямо таки чувствовал, что XML можно обрабатывать и с их помощью. Так и вышло: нашелся пакет <code>xml-lens</code>! Разбор документа далее будет производиться с его помощью:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import </span><span class="dt">Control.Applicative</span> ((&lt;$&gt;), (&lt;*&gt;))
<span class="kw">import </span><span class="dt">Text.XML.Lens</span>       (attr, el, named, root, (./), (^?))

<span class="ot">getWeather ::</span> <span class="dt">Document</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Weather</span>
getWeather doc <span class="fu">=</span>
  <span class="kw">do</span> feed      <span class="ot">&lt;-</span> doc <span class="fu">^?</span> root <span class="fu">.</span> el <span class="st">&quot;rss&quot;</span> <span class="fu">./</span> el <span class="st">&quot;channel&quot;</span>
     units     <span class="ot">&lt;-</span> feed <span class="fu">^?</span> el <span class="st">&quot;channel&quot;</span> <span class="fu">./</span> named <span class="st">&quot;units&quot;</span> <span class="fu">.</span> attr <span class="st">&quot;temperature&quot;</span>
     city      <span class="ot">&lt;-</span> feed <span class="fu">^?</span> el <span class="st">&quot;channel&quot;</span> <span class="fu">./</span> named <span class="st">&quot;location&quot;</span> <span class="fu">.</span> attr <span class="st">&quot;city&quot;</span>
     country   <span class="ot">&lt;-</span> feed <span class="fu">^?</span> el <span class="st">&quot;channel&quot;</span> <span class="fu">./</span> named <span class="st">&quot;location&quot;</span> <span class="fu">.</span> attr <span class="st">&quot;country&quot;</span>
     condition <span class="ot">&lt;-</span> feed <span class="fu">^?</span> el <span class="st">&quot;channel&quot;</span> <span class="fu">./</span> el <span class="st">&quot;item&quot;</span> <span class="fu">./</span> named <span class="st">&quot;condition&quot;</span>
     <span class="dt">Weather</span> city country
         <span class="fu">&lt;$&gt;</span> condition <span class="fu">^?</span> attr <span class="st">&quot;temp&quot;</span>
         <span class="fu">&lt;*&gt;</span> toTempUnit units
         <span class="fu">&lt;*&gt;</span> condition <span class="fu">^?</span> attr <span class="st">&quot;date&quot;</span>
         <span class="fu">&lt;*&gt;</span> condition <span class="fu">^?</span> attr <span class="st">&quot;text&quot;</span>
  <span class="kw">where</span>
<span class="ot">    toTempUnit ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">TempUnits</span>
    toTempUnit <span class="fu">=</span> flip lookup [(<span class="st">&quot;C&quot;</span>, <span class="dt">Celsiuses</span>), (<span class="st">&quot;F&quot;</span>, <span class="dt">Farenheits</span>)]</code></pre></div>
<p>XML-линзы выглядят необычно, но для тем, кто знаком с линзами в целом, разобраться труда не составит. Сам код же вполне читаем получился, что особо порадовало.</p>
<h2 id="также-доступны-следующие-опции">“Также доступны следующие опции…”</h2>
<p>Опции программы нужно где-то хранить, для этой цели был добавлен тип:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">data</span> <span class="dt">Config</span> <span class="fu">=</span> <span class="dt">Config</span>
            {<span class="ot"> cityID    ::</span> <span class="dt">Maybe</span> <span class="dt">CityID</span>
            ,<span class="ot"> tempUnits ::</span> <span class="dt">TempUnits</span>
            ,<span class="ot"> proxy     ::</span> <span class="dt">Maybe</span> <span class="dt">Proxy</span> }</code></pre></div>
<p>Командную строку я решил разбирать с помощью библиотеки <code>optparse-applicative</code>. Встретил её я какое то время назад, но использовать пакет ещё не доводилось. Здесь же библиотека очень пригодилась. Парсер опций с выглядит так:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import </span><span class="dt">Options.Applicative</span>       (<span class="dt">Parser</span>, execParser, flag, fullDesc,
                                  header, help, helper, info, long,
                                  metavar, option, progDesc, short,
                                  strOption, (<span class="fu">&lt;&gt;</span>))
<span class="kw">import </span><span class="dt">Options.Applicative.Types</span> (<span class="dt">ParseError</span> (<span class="dt">ErrorMsg</span>), <span class="dt">ReadM</span> (..))

<span class="fu">...</span>

<span class="ot">opts ::</span> <span class="dt">Parser</span> <span class="dt">Config</span>
opts <span class="fu">=</span> <span class="dt">Config</span>
  <span class="fu">&lt;$&gt;</span> optional (strOption
      (long <span class="st">&quot;city&quot;</span>
    <span class="fu">&lt;&gt;</span> short <span class="ch">'c'</span>
    <span class="fu">&lt;&gt;</span> metavar <span class="st">&quot;CITY&quot;</span>
    <span class="fu">&lt;&gt;</span> help <span class="st">&quot;Yahoo weather API's city ID&quot;</span>))

  <span class="fu">&lt;*&gt;</span> flag <span class="dt">Celsiuses</span> <span class="dt">Farenheits</span>
      (long <span class="st">&quot;farenheits&quot;</span>
    <span class="fu">&lt;&gt;</span> short <span class="ch">'F'</span>
    <span class="fu">&lt;&gt;</span> help <span class="st">&quot;Show temperature in Farenheits (default: Celsiuses)&quot;</span>)

  <span class="fu">&lt;*&gt;</span> optional (option extractProxy
      (long <span class="st">&quot;proxy&quot;</span>
    <span class="fu">&lt;&gt;</span> short <span class="ch">'p'</span>
    <span class="fu">&lt;&gt;</span> help <span class="st">&quot;Proxy server in format [user:pass@]host[:port]&quot;</span>))

  <span class="kw">where</span>
    extractProxy <span class="fu">=</span>
      <span class="dt">ReadM</span> <span class="fu">.</span> maybe (<span class="dt">Left</span> (<span class="dt">ErrorMsg</span> <span class="st">&quot;Wrong proxy string! (see --help)&quot;</span>)) <span class="dt">Right</span>
            <span class="fu">.</span> parseProxy</code></pre></div>
<p>Сам же интерфейс командной строки описывается так:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">cli ::</span> <span class="dt">IO</span> <span class="dt">Config</span>
cli <span class="fu">=</span> execParser
    <span class="fu">$</span> info (helper <span class="fu">&lt;*&gt;</span> opts)
      (fullDesc
    <span class="fu">&lt;&gt;</span> progDesc <span class="st">&quot;Print current weather for CITY&quot;</span>
    <span class="fu">&lt;&gt;</span> header <span class="st">&quot;weather - Yahoo Weather displaying tool&quot;</span>)</code></pre></div>
<p>Библиотека, кроме собственно реализации опций, даёт ещё и возможность генерировать автоматически справку по ключам и опциям. Выглядит справка так:</p>
<pre><code>$ weather --help
weather - Yahoo Weather displaying tool

Usage: weather [-c|--city CITY] [-F|--farenheits] [-p|--proxy ARG]
  Print current weather for CITY

Available options:
  -h,--help                Show this help text
  -c,--city CITY           Yahoo weather API's city ID
  -F,--farenheits          Show temperature in Farenheits (default: Celsiuses)
  -p,--proxy ARG           Proxy server in format [user:pass@]host[:port]</code></pre>
<h2 id="всех-их-вместе-соберем">“Всех их вместе соберем!”</h2>
<p>Ну вот, в общем то, и всё, что нужно для сборки готовой программы. Осталась самая малость - main-функция:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import </span><span class="dt">System.Exit</span> (<span class="dt">ExitCode</span>(..), exitWith)

<span class="fu">...</span>

<span class="ot">main ::</span> <span class="dt">IO</span> ()
main <span class="fu">=</span> cli <span class="fu">&gt;&gt;=</span> doSomeWork <span class="fu">&gt;&gt;=</span> exitWith

<span class="ot">doSomeWork ::</span> <span class="dt">Config</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">ExitCode</span>
doSomeWork cfg <span class="fu">=</span> <span class="kw">do</span>
  resp <span class="ot">&lt;-</span> simpleRequest
    (proxy cfg)
    (mkAPIUrl (fromMaybe <span class="st">&quot;2121267&quot;</span> <span class="co">-- default city is Kazan'</span>
                         (cityID cfg))
              (tempUnits cfg))
  <span class="kw">let</span> weather <span class="fu">=</span> resp <span class="fu">&gt;&gt;=</span> parseDocument <span class="fu">&gt;&gt;=</span> getWeather
  maybe (return <span class="fu">$</span> <span class="dt">ExitFailure</span> <span class="dv">1</span>)
        ((<span class="fu">&gt;&gt;</span> return <span class="dt">ExitSuccess</span>) <span class="fu">.</span> putStrLn <span class="fu">.</span> renderWeather)
        weather</code></pre></div>
<p><strong>Всё!</strong></p>
<p>Вот и готово полезное приложение, и, что ещё важнее, опробованы удобные и мощные инструменты! Целиком же код можно посмотреть <a href="https://bitbucket.org/astynax/weather/overview">тут</a>.</p>

<div id="socialButtons">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ru">Твитнуть</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

    <div class="g-plus" data-action="share" data-annotation="bubble"></div>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'ruhaskell'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    

        </div>

        <div id="searchForm">
            <script>
              (function() {
                var cx = '007697214108744450483:w49n7qbvpdy';
                var gcse = document.createElement('script');
                gcse.type = 'text/javascript';
                gcse.async = true;
                gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                    '//www.google.com/cse/cse.js?cx=' + cx;
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(gcse, s);
              })();
            </script>
            <gcse:search></gcse:search>
        </div>

        <footer class="footer">
            Сайт работает на <strong><a href="http://jaspervdj.be/hakyll/" target="_blank">Hakyll</a></strong> и живёт на <strong><a href="https://github.com/ruHaskell/ruhaskell" target="_blank">GitHub</a></strong>.
            <div class="stargaze">
                <a data-count-api="/repos/ruHaskell/ruhaskell#stargazers_count" data-count-href="/ruHaskell/ruhaskell/stargazers" data-icon="octicon-star" href="https://github.com/ruHaskell/ruhaskell" class="github-button">Star</a>

                <span style="padding-left: 20px;"></span>

                <a data-count-api="/repos/ruHaskell/ruhaskell#forks_count" data-count-href="/ruHaskell/ruhaskell/network" data-icon="octicon-git-branch" href="https://github.com/ruHaskell/ruhaskell" class="github-button">Fork</a>
            </div>

            <div class="copyright-note">
                Исходный код данного сайта, а также все опубликованные на нём материалы распространяются на условиях <a href="https://github.com/ruHaskell/ruhaskell/blob/master/LICENSE" target="_blank">свободной лицензии MIT</a>.
            </div>
        </footer>
    </div>

<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'ruhaskell'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
var s = document.createElement('script'); s.async = true;
s.type = 'text/javascript';
s.src = '//' + disqus_shortname + '.disqus.com/count.js';
(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>

  </body>
</html>
