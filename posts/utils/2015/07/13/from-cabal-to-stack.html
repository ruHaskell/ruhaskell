<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content>
        <meta name="author" content>
        <link rel="icon" href="../../../../../static/images/favicon.ico">

        <title>Прощай, cabal. Здравствуй, stack!</title>

        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">

        <link href="../../../../../static/css/default.css" rel="stylesheet">
        
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

        <script>
          window.___gcfg = {
            lang: 'ru'
          };
        </script>

        <script src="https://apis.google.com/js/platform.js" async defer>
        </script>
    
        <link rel="alternate" type="application/rss+xml" title="RSS" href="http://ruhaskell.org/feed.xml" />
        
        <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>
    </head>

  <body>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-58217738-1', 'auto');
      ga('send', 'pageview');

    </script>

    <div class="container">
        <nav class="navbar navbar-default navbar-fixed-top">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <div id="ruhaskell-logo">
                <a class="navbar-brand" href="../../../../../" title="Домой">
                  <img alt="ruHaskell" src="../../../../../static/images/logo.png" width="60">
                </a>
              </div>
            </div>
            
            <div id="navbar" class="collapse navbar-collapse">
              <ul class="nav navbar-nav">
                <li class="dropdown">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Публикации<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li>
                        <a href="../../../../../archive.html">
                            <span class="archive-link">
                                <span class="fa fa-pencil"></span>
                            </span>Статьи
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../tags.html">
                            <span class="tags-link">
                                <span class="fa fa-tags"></span>
                            </span>Теги
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../categories.html">
                            <span class="categories-link">
                                <span class="fa fa-star"></span>
                            </span>Категории
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../authors.html">
                            <span class="authors-link">
                                <span class="fa fa-users"></span>
                            </span>Авторы
                        </a>
                    </li>
                  </ul>
                </li>

                <li class="dropdown">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Общение<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li>
                        <a href="https://gitter.im/ruHaskell/forall" target="_blank">
                            <span class="chat-link">
                                <span class="fa fa-smile-o"></span>
                            </span>Чат
                        </a>
                    </li>
                    <li>
                        <a href="http://forum.ruhaskell.org" target="_blank">
                            <span class="group-link">
                                <span class="fa fa-group"></span>
                            </span>Форум
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../maillist.html">
                            <span class="group-link">
                                <span class="fa fa-group"></span>
                            </span>Список рассылки
                        </a>
                    </li>
                  </ul>
                </li>

                <li><a href="../../../../../links.html">Ссылки</a></li>
              </ul>

              <ul class="nav navbar-nav navbar-right">
                <li class="dropdown">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Присоединяйтесь!<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li>
                        <a href="https://github.com/ruHaskell/ruhaskell" target="_blank">
                            <span id="github-link">
                                <span class="fa fa-github-square"></span>
                            </span>GitHub
                        </a>
                    </li>
                    <li>
                        <a href="https://plus.google.com/communities/117343381540538069054" target="_blank">
                            <span id="google-plus-link">
                                <span class="fa fa-google-plus-square"></span>
                            </span>Google+
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../feed.xml">
                            <span id="rss-link">
                                <span class="fa fa-rss-square"></span>
                            </span>RSS
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../itunes-feed.xml">
                            <span id="itunes-rss-link">
                                <span class="fa fa-rss-square"></span>
                            </span>iTunes
                        </a>
                    </li>
                  </ul>
                </li>
              </ul>
            </div>
          </div>
        </nav>

        <div id="content">
            <h1>Прощай, cabal. Здравствуй, stack!</h1>

<div class="row">
    <div class="col-xs-9 col-sm-8 col-md-8 col-lg-8">
        <div class="post-info">
            <strong>let</strong> author&nbsp;&nbsp;&nbsp;= "<a href="../../../../../authors/%25D0%2594%25D0%25B5%25D0%25BD%25D0%25B8%25D1%2581%2520%25D0%25A8%25D0%25B5%25D0%25B2%25D1%2587%25D0%25B5%25D0%25BD%25D0%25BA%25D0%25BE.html">Денис Шевченко</a>"<br />
            &nbsp;&nbsp;&nbsp;&nbsp;date&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= fromGregorian 2015 jul 13<br />
            &nbsp;&nbsp;&nbsp;&nbsp;category = "<a href="../../../../../categories/utils.html">Утилиты</a>"<br />
            &nbsp;&nbsp;&nbsp;&nbsp;tags&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= [&quot;<a href="../../../../../tags/stack.html">stack</a>&quot;, &quot;<a href="../../../../../tags/cabal.html">cabal</a>&quot;]
        </div>
    </div>

    <div class="col-xs-3 col-sm-4 col-md-4 col-lg-4">
        
    </div>
</div>

<p>Приветствую, друзья!</p>
<p>Наконец-то я добрался до этой темы. А то слух, знаете ли, всё громче и громче, а что к чему - знают не все. В общем, решил я разобраться с новым Haskell-инструментом под названием <code>stack</code>.</p>
<h2 id="о-чём-идёт-речь">О чём идёт речь</h2>
<p>Утилита <code>stack</code> - это новый инструмент от команды <a href="https://www.fpcomplete.com">FP Complete</a>, предназначенный для работы с Haskell-проектами. Штуковина очень молодая (первая версия датируется июнем сего года), однако шуму наделать уже успела.</p>
<p>Постойте, скажете вы, у нас же есть старый добрый <code>cabal</code>! Да, есть, но, как показала практика, не такой уж он и добрый. И вот теперь настал его смертный час, ибо к нам пришёл <code>stack</code>…</p>
<h2 id="замена-cabal">Замена Cabal?</h2>
<p>Определимся с понятиями. Когда мы слышим слово “кабал” - речь может идти о:</p>
<ol style="list-style-type: decimal">
<li>спецификации Cabal (“Common Architecture for Building Applications and Libraries”) и формате метаданных Haskell-проекта. Тот самый формат, который мы видим в файле с расширением <code>.cabal</code>;</li>
<li>реализации спецификации Cabal в виде <a href="http://hackage.haskell.org/package/Cabal">библиотеки Cabal</a>;</li>
<li>утилите <code>cabal-install</code>, в виде знакомой нам команды <code>cabal</code>.</li>
</ol>
<p>Так вот утилита <code>stack</code> - это замена утилите <code>cabal-install</code>. Больше не будет никаких <code>cabal update</code> и <code>cabal sandbox init</code>. Кстати, некоторые ошибочно полагали, что <code>stack</code> представляет собой надстройку над <code>cabal-install</code> и скрыто использует последнюю, однако это не так: <code>stack</code> использует Cabal-библиотеку (см. выше пункт 2), но никак не соприкасается с <code>cabal-install</code>. Иными словами, вы можете спокойно удалить <code>cabal-install</code> с вашего компьютера и забыть о ней навсегда.</p>
<h2 id="зачем-это-было-нужно">Зачем это было нужно</h2>
<p>По результатам <a href="https://www.fpcomplete.com/blog/2015/05/thousand-user-haskell-survey">большого опроса</a>, проведённого среди множества коммерческих пользователей Haskell, главной болью при работе с Haskell-проектами была-таки <code>cabal-install</code>. Для этой боли даже название придумали: “cabal hell”. А всё дело было в сложных/перекрёстных зависимостях между (многочисленными) пакетами, задействованными в ваших проектах. Фундаментальная проблема <code>cabal-install</code> такова:</p>
<blockquote>
<p>То, что работает сегодня, может перестать работать завтра.</p>
</blockquote>
<p>Естественно, такое положение дел не устраивало сообщество, а в особенности тех, кто уже использовал Haskell в коммерческих проектах. Никому не хочется столкнуться с ситуацией, когда, после очередного <code>cabal update</code>, проект, прекрасно собирающийся вчера вечером, перестаёт собираться сегодня днём. Подобная непредсказуемость неизбежно разрушает доверие.</p>
<p>Были предприняты попытки решить указанную проблему. В <code>cabal-1.18</code> были введены песочницы, а в <code>cabal-1.20</code> - команда <code>cabal freeze</code>. Теперь проекты могли быть изолированными друг от друга, а пакетные зависимости можно было заморозить. И проблемы действительно уменьшились, но, к сожалению, не ушли. Поэтому команда FP Complete создаёт <code>stack</code>. Цель этого проекта - избавить мир от <code>cabal hell</code>, раз и навсегда. А заодно максимально упростить работу с проектами.</p>
<h2 id="поехали">Поехали</h2>
<p>Идём <a href="https://github.com/commercialhaskell/stack/wiki/Downloads">сюда</a> и скачиваем <code>stack</code> для своей ОС. На момент написания данной статьи последней версией была <code>1.2.0</code>, датируемая 6 июля. После скачивания архива распаковываем его - и вот он наш файлик. Переименовываем его в <code>stack</code>, делаем исполняемым, копируем куда-нибудь в <code>PATH</code> (я положил в <code>/usr/local/bin</code>) - и можно работать.</p>
<h2 id="начнём-с-пустышки">Начнём с пустышки</h2>
<p>Делаем следующее:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">mkdir</span> probe
$ <span class="kw">cd</span> probe
$ <span class="kw">stack</span> new</code></pre></div>
<p>Команда <code>new</code> создаёт простейший проект-пустышку в текущем каталоге:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">ls</span>
<span class="kw">LICENSE</span>
<span class="kw">Setup.hs</span>
<span class="kw">app/</span>
<span class="kw">new-template.cabal</span>
<span class="kw">src/</span>
<span class="kw">stack.yaml</span>
<span class="kw">test/</span></code></pre></div>
<p>Перед нами - самый обыкновенный Haskell-проект. Кстати, он прямо сейчас, без каких-либо дополнительных манипуляций готов к сборке, в отличие от проекта, создаваемого с помощью <code>cabal init</code>.</p>
<p>Самая важная часть, которой не было раньше - файл <code>stack.yaml</code>. Заглянем в него:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">flags:</span> <span class="kw">{}</span>
<span class="fu">packages:</span>
<span class="kw">-</span> <span class="st">'.'</span>
<span class="fu">extra-deps:</span> <span class="kw">[]</span>
<span class="fu">resolver:</span> lts-2.15</code></pre></div>
<p>Обратите внимание на последнюю строчку, ибо она очень, очень важна. <code>lts-2.15</code> - это версия нашей Haskell-экосистемы. LTS - от “Long Term Support” - представляет собой фиксированный набор Haskell-пакетов. Но что значит “фиксированный набор”? Поясню.</p>
<h2 id="stackage">Stackage</h2>
<p>Как мы знаем, наш любимый <a href="http://hackage.haskell.org/packages/">Hackage</a> содержит очень много пакетов: на данный момент их чуть более 8400 штук. Но будет честными - далеко не всё из этой кучи пригодно для реального применения. Многие из пакетов - сугубо экспериментальные (читай “игрушечные”), а есть и вообще заброшенные. Поэтому друзья из FP Complete придумали Stackage, от “Stable Hackage”.</p>
<p>Идея в следующем: отобрать часть конкретных пакетов - и закрепить их в своего рода снимке (snapshot), присвоив этому снимку версию. Например, снимок версии 2.15 включает в себя 1066 пакетов, причём версия каждого из них явно указана (взгляните на <a href="https://www.stackage.org/lts-2.15">список</a>).</p>
<p>Именно благодаря этому мы избавляемся от упомянутой выше непредсказуемости. Версия <code>lts</code>-снимка однозначно определяет версию каждого пакета, используемого в нашем проекте. Поэтому когда N программистов, работающих с неким проектом, используют одну и ту же версию <code>lts</code>-снимка - у них всё гарантированно работает (как сегодня, так и завтра).</p>
<p>Это особенно полезно при расширении разработки. Пришёл новый человек в команду - никаких проблем с вечно обновляющимися пакетами: он просто берёт ту же версию снимка, что и все остальные коллеги, собирает - и у него всё ок.</p>
<h2 id="собираем">Собираем</h2>
<p>Пора собрать наш проект:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">stack</span> build
<span class="kw">Downloaded</span> lts-2.15 build plan.
<span class="kw">Caching</span> build plan
<span class="kw">Fetched</span> package index.
<span class="kw">Populated</span> index cache.
<span class="kw">GHC</span> version mismatched, found 7.8.3 (x86_64), <span class="kw">but</span> expected version 7.8.4 (x86_64) <span class="kw">(based</span> on resolver setting in /Users/dshevchenko/probe_stack/stack.yaml<span class="kw">).</span> <span class="kw">Try</span> running stack setup</code></pre></div>
<p>В начале происходит загрузка “lts-2.15 build plan”, чтобы <code>stack</code> понял, с какими версиями пакетов следует работать в данном проекте. А теперь обратите внимание на последнюю строчку: <code>stack</code> сообщает нам о несоответствии версий GHC. На моей машине стоит 7.8.3, однако ожидается версия 7.8.4. Заглянем на <a href="https://www.stackage.org/lts-2.15">lts-страницу</a> - так и есть:</p>
<blockquote>
<p>LTS Haskell 2.15 - GHC 7.8.4</p>
</blockquote>
<p>Данный снимок был проверен с использованием 7.8.4, а следовательно, эту версию и нужно использовать. Однако на моей машине, в рамках последней Haskell Platform, установлена версия 7.8.3. Что же делать? Следует установить версию 7.8.4 (спасибо, Кэп!).</p>
<h2 id="ставим-нужный-компилятор">Ставим нужный компилятор</h2>
<p>К счастью, возможность установки нужного компилятора входит в обязанности <code>stack</code>! Да-да, он и это умеет. Более того, он сам подсказал нам нужную команду. Вспомните ту самую последнюю строчку, в самом конце: “Try running stack setup”. Сделаем же это:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">stack</span> setup
<span class="kw">Downloaded</span> ghc-7.8.4.
<span class="kw">Installed</span> GHC.
<span class="kw">Would</span> add the following to PATH: /Users/dshevchenko/.stack/programs/x86_64-osx/ghc-7.8.4/bin</code></pre></div>
<p>Немного терпения - и новый компилятор готов к использованию. Обратите внимание, что установлен он в скрытый каталог <code>.stack</code>, созданный в вашем домашнем каталоге. Следовательно, никаких конфликтов с уже имеющимся компилятором не будет:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">ghc</span> --version
<span class="kw">The</span> Glorious Glasgow Haskell Compilation System, version 7.8.3</code></pre></div>
<p>Новая версия 7.8.4 будет использоваться исключительно в процессе сборки нашего проекта. А кстати, вдруг я вас обманываю? Как мы можем проверить версию реально используемого компилятора? Очень просто, ведь <code>stack</code> умеет запускать интерпретатор <code>ghci</code>:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">stack</span> ghci
<span class="kw">Configuring</span> GHCi with the following packages: new-template
<span class="kw">GHCi</span>, version 7.8.4: http://www.haskell.org/ghc/  :? for help
<span class="kw">...</span></code></pre></div>
<p>Та-дам! Действительно 7.8.4.</p>
<h2 id="теперь-уже-точно-собираем">Теперь уже точно собираем</h2>
<p>Выполняем:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">stack</span> build
<span class="kw">new-template-0.1.0.0</span>: configure
<span class="kw">Configuring</span> new-template-0.1.0.0...
<span class="kw">new-template-0.1.0.0</span>: build
<span class="kw">Building</span> new-template-0.1.0.0...
<span class="kw">Preprocessing</span> library new-template-0.1.0.0...
[<span class="kw">1</span> of 1] Compiling Lib              ( src/Lib.hs, .stack-work/dist/x86_64-osx/Cabal-1.18.1.5/build/Lib.o )
<span class="kw">In-place</span> registering new-template-0.1.0.0...
<span class="kw">Preprocessing</span> executable <span class="st">'new-template-exe'</span> for new-template-0.1.0.0...
[<span class="kw">1</span> of 1] Compiling Main             ( app/Main.hs, .stack-work/dist/x86_64-osx/Cabal-1.18.1.5/build/new-template-exe/new-template-exe-tmp/Main.o )
<span class="kw">Linking</span> .stack-work/dist/x86_64-osx/Cabal-1.18.1.5/build/new-template-exe/new-template-exe ...
<span class="kw">new-template-0.1.0.0</span>: install
<span class="kw">Installing</span> library in
<span class="kw">/Users/dshevchenko/probe_stack/.stack-work/install/x86_64-osx/lts-2.15/7.8.4/lib/x86_64-osx-ghc-7.8.4/new-template-0.1.0.0</span>
<span class="kw">Installing</span> executable(s) <span class="kw">in</span>
<span class="kw">/Users/dshevchenko/probe_stack/.stack-work/install/x86_64-osx/lts-2.15/7.8.4/bin</span>
<span class="kw">Registering</span> new-template-0.1.0.0...</code></pre></div>
<p>Как видите, в корне проекта появился скрытый каталог <code>.stack-work</code>, в котором и осуществляется вся сборка. Взгляните, куда установилась наша программка:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">~/.stack-work/install/x86_64-osx/lts-2.15/7.8.4/bin</span></code></pre></div>
<p>Как видите, указана не только версия используемого компилятора, но и версия используемого <code>lts</code>-снимка.</p>
<h2 id="проверяем-версии-пакетов">Проверяем версии пакетов</h2>
<p>Итак, собрали. А теперь убедимся в правоте наших ожиданий в отношении версий используемых пакетов.</p>
<p>Раньше версии пакетов (или диапазоны версий) указывались в <code>.cabal</code>-файле, в секции <code>build-depends</code>:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">    build<span class="fu">-</span>depends<span class="fu">:</span>   split    <span class="fu">&gt;=</span><span class="fl">0.2</span>    <span class="fu">&amp;&amp;</span> <span class="fu">&lt;</span><span class="fl">0.3</span>,
                     filepath <span class="fu">&gt;=</span><span class="fl">1.3</span>    <span class="fu">&amp;&amp;</span> <span class="fu">&lt;</span><span class="fl">1.4</span>,
    <span class="fu">...</span></code></pre></div>
<p>Теперь же, как мы помним, версии пакетов определяются используемым нами <code>lts</code>-снимком. Проверим это.</p>
<p>Я воспользуюсь одним из своих блогов, создаваемых, как многие знают, с помощью <code>hakyll</code>. Проект зависит от маленькой библиотеки <code>split</code>, помогающей разделывать строчки на кусочки. <code>lts</code>-снимок версии 2.15 содержит указание версии:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">...</span>
<span class="kw">split-0.2.2</span>         Combinator library for splitting lists
<span class="kw">...</span></code></pre></div>
<p>Итак, используется 0.2.2. А теперь я сделаю вид, что напутал с версиями и указал в <code>.cabal</code>-файле следующее:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">    build<span class="fu">-</span>depends<span class="fu">:</span>   split  <span class="fu">==</span><span class="fl">0.3</span><span class="fu">.*</span>,
    <span class="fu">...</span></code></pre></div>
<p>На самом деле, версия 0.2.2 является последней, но суть не в этом. Суть в том, что проект не соберётся, потому что <code>stack</code> строг и аккуратен по отношению к версиям.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">cd</span> hand
$ <span class="kw">stack</span> init
<span class="kw">Writing</span> default config file to: /Users/dshevchenko/hand/stack.yaml
<span class="kw">Basing</span> on cabal files:
<span class="kw">-</span> /Users/dshevchenko/hand/hand.cabal

<span class="kw">Checking</span> against build plan lts-2.15

<span class="kw">*</span> Build plan did not match your requirements:
    <span class="kw">split</span> version 0.2.2 found
    <span class="kw">-</span> hand requires ==0.3.*</code></pre></div>
<p>Первое, на что следует обратить внимание - новая команда. Мы используем <code>stack init</code>, потому что собираемся использовать <code>stack</code> для <em>уже существующего</em> Haskell-проекта. <code>stack</code> создаёт в его корне уже знакомый нам файл <code>stack.yaml</code>. И кстати, если в корне вашего проекта есть <code>cabal</code>-песочницы или файл <code>cabal.config</code> - смело удаляйте всё это.</p>
<p>Сразу после создания <code>.yaml</code>-файла <code>stack</code> проверяет готовность проекта быть собранным в соответствии с <code>lts</code>-снимком версии 2.15. И тут - неприятный, но вполне ожидаемый результат:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">*</span> Build plan did not match your requirements:
    <span class="kw">split</span> version 0.2.2 found
    <span class="kw">-</span> hand requires ==0.3.*</code></pre></div>
<p>Версии пакета в <code>.lts</code>-снимке и в <code>.cabal</code>-файле различаются, поэтому сборка не пройдёт. Решение - убрать указание версий из <code>.cabal</code>-файла (ещё раз спасибо, Кэп!). Больше никакой путаницы - версии всех используемых пакетов явно указаны в <code>lts</code>-снимке, и нигде более.</p>
<h2 id="больше-компиляторов-хороших-и-разных">Больше компиляторов, хороших и разных</h2>
<p>Ну что ж, раз можно поставить дополнительный “локальный” компилятор, исходя из версии экосистемы конкретного проекта, значит, можно поставить и несколько компиляторов.</p>
<p>Допустим, я хочу поэкспериментировать с новым GHC 7.10.1 с существующим проектом. Перехожу в проект:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">cd</span> new_hs_project
$ <span class="kw">stack</span> init</code></pre></div>
<p>Теперь открываем <code>stack.yaml</code> и заменяем последнюю строчку на:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">resolver</span>: nightly-2015-07-12</code></pre></div>
<p>Оказывается, <code>lts</code>-снимок - не единственная возможность указания Haskell-экосистемы. LTS прекрасно подходит для серьёзных долгоживущих проектов, но для экспериментаторов, предпочитающих быть на гребне волны, подойдёт одна из ночных сборок. В данном случае - сборка от 12 июля сего года. Живёт она <a href="http://www.stackage.org/nightly-2015-07-12">здесь</a>. Откроем её:</p>
<blockquote>
<p>Stackage Nightly 2015-07-12 - GHC 7.10.1</p>
</blockquote>
<p>То, что нам нужно! Раз данная сборка проверена с помощью 7.10.1, то при выполнении команды <code>stack setup</code> произойдёт установка именно этой версии компилятора:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">stack</span> setup
<span class="kw">Downloaded</span> ghc-7.10.1.
<span class="kw">Installed</span> GHC.
<span class="kw">Would</span> add the following to PATH: /Users/dshevchenko/.stack/programs/x86_64-osx/ghc-7.10.1/bin</code></pre></div>
<p>И теперь у нас есть два разных компилятора, не мешающих друг другу. Соответственно, все мои проекты, зависящие от 7.8.4, будут использовать только его, а проекты, зависящие от 7.10.1 - его. Никакой путаницы.</p>
<h2 id="а-куда-он-ставит-пакеты">А куда он ставит пакеты?</h2>
<p>До появляения <code>cabal sandbox</code> все пакеты ставились в глобальное пространство, и это было ужасно. Идея песочницы частично решила проблему: каждый проект теперь скрыто включал свою собственную песочницу, в которую устанавливалось всё, необходимое для данного проекта.</p>
<p>Вроде бы неплохое решение, но оно грубое в силу своей избыточности. Представьте себе, что у вас на машине есть три <code>yesod</code>-проекта. Соответственно, у вас появится три песочницы с тремя <em>полными копиями</em> всех пакетов, входящих в <code>yesod</code>-зависимости (кто работал с <code>yesod</code>, тот знает, что зависимостей этих, мягко выражаясь, много). Во-первых, попусту растрачивается дисковое пространство, а во-вторых, при появлении четвёртого <code>yesod</code>-проекта (ну вот любите вы <code>yesod</code>, почему бы и нет?) весь <code>yesod</code> будет заново установлен в чертвёртую песочницу. И особенно обидно будет при условии, если во всех четырёх проектах используется одна и та же версия <code>yesod</code>…</p>
<p>В <code>stack</code> всё умнее. Больше никаких избыточных копий пакетов внутри каждого из проектов. Теперь пакеты устанавливаются в единое глобальное место, а именно в упомянутый ранее скрытый каталог <code>.stack</code> в вашем домашнем каталоге. Но! Пакеты больше не валятся в одну кучу. Напротив, они устанавливаются иерархично, в соответствии с <code>lts</code>-снимками (ну и ночными сборками, если таковые используются).</p>
<p>Заглянем:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">ls</span> ~/.stack/snapshots/x86_64-osx/
<span class="kw">lts-2.15</span>
<span class="kw">nightly-2015-07-12</span></code></pre></div>
<p>Вот они, наши снимки. Глянем поглубже:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">ls</span> ~/.stack/snapshots/x86_64-osx/lts-2.15/7.8.4/lib/x86_64-osx-ghc-7.8.4/
<span class="kw">HTTP-4000.2.19</span>                          data-default-instances-containers-0.0.1 regex-tdfa-1.2.0
<span class="kw">HUnit-1.2.5.2</span>                           data-default-instances-dlist-0.0.1      resourcet-1.1.5
<span class="kw">JuicyPixels-3.2.5.2</span>                     data-default-instances-old-locale-0.0.1 rfc5051-0.1.0.3
<span class="kw">MonadCatchIO-transformers-0.3.1.3</span>       deepseq-generics-0.1.1.2                scientific-0.3.3.8
<span class="kw">...</span></code></pre></div>
<p>И вот они, все наши пакеты. Из пути сразу понятно, о каком снимке идёт речь и какая версия компилятора используется.</p>
<p>Таким образом, если упомянутые ранее три <code>yesod</code>-проекта используют одну и ту же версию <code>lts</code>-снимка - скажем, <code>2.15</code> - тогда использованы будут пакеты из каталога <code>~/.stack/snapshots/x86_64-osx/lts-2.15/7.8.4/</code>. Если же четвёртый <code>yesod</code>-проект будет использовать, скажем, одну из ночных сборок совместно с GHC 7.10.1, то будут использованы пакеты из <code>~/.stack/snapshots/x86_64-osx/nightly-2015-07-12/7.10.1/</code>. Никаких излишних копий, и при этом никаких конфликтов.</p>
<h2 id="за-пределами-снимка">За пределами снимка</h2>
<p>Как было сказано выше, <code>lts</code>-снимки (равно как и ночные сборки) содержат не всё то, что есть на просторах Hackage. Ну а вдруг мой проект использует некий пакет, которого нет в используемом мною снимке! Что делать?</p>
<p>Допустим, мне понадобился какой-нибудь <a href="http://hackage.haskell.org/package/string-qq"><code>string-qq</code></a>. Если я просто укажу его в своём <code>.cabal</code>-файле, при попытке сборки <code>stack</code> выразит свой категорический протест:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">--</span>  While attempting to add dependency,
    <span class="kw">Could</span> not find package string-qq in known packages</code></pre></div>
<p>Поэтому открываем <code>stack.yaml</code>, ищем строчку:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">extra-deps:</span> <span class="kw">[]</span></code></pre></div>
<p>и заменяем её на:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">extra-deps:</span>
<span class="kw">-</span> string-qq-0.0.2</code></pre></div>
<p>Готово. Теперь при сборке <code>stack</code> увидит, что данный пакет нужно искать не в используемом снимке, а напрямую в Hackage. Соответственно, если мне вдруг понадобится более одного внешнего пакета, я просто дописываю их следом:</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">extra-deps:</span>
<span class="kw">-</span> string-qq-0.0.2
<span class="kw">-</span> hfsevents-0.1.5</code></pre></div>
<p>И всё заработает.</p>
<h2 id="установка-в-удобное-место">Установка в удобное место</h2>
<p>Иногда после сборки проекта бывает удобно установить исполняемый файл приложения в какое-нибудь доступное место. Для этого служит команда <code>install</code>:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">stack</span> install
<span class="kw">Copying</span> from /Users/dshevchenko/probe/.stack-work/install/x86_64-osx/lts-2.15/7.8.4/bin/new-template-exe to /Users/dshevchenko/.local/bin/new-template-exe</code></pre></div>
<p>И если путь <code>~/.local/bin/</code> добавлен в PATH, то приложение будет немедленно доступно напрямую. Весьма удобно.</p>
<h2 id="вывод">Вывод</h2>
<p>Вывод только один - классную штуку сделали друзья из FP Complete. Лично я перевожу на <code>stack</code> все мои проекты. Прощай, <code>cabal</code>!</p>
<p>Кстати, если вы работаете на Linux - для вас хорошая новость: для Ubuntu, Debian, CentOS/Red Hat и Fedora уже готовы <a href="https://github.com/commercialhaskell/stack/wiki/Downloads#ubuntu">соответствующие пакеты</a>. Ну а нам, маководам, осталось дождаться добавления <code>stack</code> в <code>brew</code>… ;-)</p>
<h2 id="полезные-ссылки">Полезные ссылки</h2>
<ul>
<li><a href="https://www.fpcomplete.com/blog/2015/06/why-is-stack-not-cabal">FP Complete про stack</a>.</li>
<li><a href="https://github.com/commercialhaskell/stack/wiki/Architecture">Архитектура stack</a>.</li>
<li>Подробнее про <a href="https://github.com/commercialhaskell/stack/wiki/stack.yaml">stack.yaml</a>.</li>
</ul>

<div id="socialButtons">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ru">Твитнуть</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

    <div class="g-plus" data-action="share" data-annotation="bubble"></div>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'ruhaskell'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    

        </div> 

        <div id="searchForm">
            <script>
              (function() {
                var cx = '007697214108744450483:w49n7qbvpdy';
                var gcse = document.createElement('script');
                gcse.type = 'text/javascript';
                gcse.async = true;
                gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                    '//www.google.com/cse/cse.js?cx=' + cx;
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(gcse, s);
              })();
            </script>
            <gcse:search></gcse:search>
        </div>

        <footer class="footer">
            Сайт работает на <strong><a href="http://jaspervdj.be/hakyll/" target="_blank">Hakyll</a></strong> и живёт на <strong><a href="https://github.com/ruHaskell/ruhaskell" target="_blank">GitHub</a></strong>.
            <div class="stargaze">
                <a data-count-api="/repos/ruHaskell/ruhaskell#stargazers_count" data-count-href="/ruHaskell/ruhaskell/stargazers" data-icon="octicon-star" href="https://github.com/ruHaskell/ruhaskell" class="github-button">Star</a>

                <span style="padding-left: 20px;"></span>            
                
                <a data-count-api="/repos/ruHaskell/ruhaskell#forks_count" data-count-href="/ruHaskell/ruhaskell/network" data-icon="octicon-git-branch" href="https://github.com/ruHaskell/ruhaskell" class="github-button">Fork</a>
            </div>

            <div class="copyright-note">
                Исходный код данного сайта, а также все опубликованные на нём материалы распространяются на условиях <a href="https://github.com/ruHaskell/ruhaskell/blob/master/LICENSE" target="_blank">свободной лицензии MIT</a>.
            </div>
        </footer>
    </div>

<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'ruhaskell'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
var s = document.createElement('script'); s.async = true;
s.type = 'text/javascript';
s.src = '//' + disqus_shortname + '.disqus.com/count.js';
(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script> 

  </body>
</html>

